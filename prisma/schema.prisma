// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id                       Int       @id @default(autoincrement())
  name                     String?
  email                    String    @unique
  
  // Champs personnalisés de votre application
  username                 String?   @unique
  first_name                String?   @map("first_name")
  last_name                 String?   @map("last_name")
  password_hash             String?   @map("password_hash")
  is_admin                  Boolean   @default(false) @map("is_admin")
  email_verified           Boolean   @default(false)
  provider                 String?
  provider_id              String?
  is_banned                 Boolean   @default(false) @map("is_banned")
  created_at                DateTime  @default(now()) @map("created_at")
  updated_at                DateTime  @default(now()) @updatedAt @map("updated_at")
  
  // Champs supplémentaires de l'application existante
  email_verification_token String?
  reset_token              String?
  reset_token_expiry       DateTime?
  terms_accepted_at        DateTime?
  profile_image            String?
  banner_image             String?

  // Relations personnalisées
  documents Document[]
  adminActions AdminAction[] @relation("AdminActions")
  targetUserActions AdminAction[] @relation("TargetUserActions")
  requests UserRequest[]
  validatedRequests UserRequest[] @relation("ValidatedRequests")
  dossiers Dossier[]

  @@map("users")
}

model Document {
  id         Int      @id @default(autoincrement())
  user_id    Int      @map("user_id")
  title      String
  content    String   @default("")
  tags       String[] @default([])
  favori     Boolean?
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  user  User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  Share Share[]
  dossiers DossierDocument[]

  @@map("documents")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Share {
  id         Int       @id @default(autoincrement())
  id_doc     Int       @map("id_doc")
  email      String
  permission Boolean   @default(false)
  favori     Boolean?
  share_at   DateTime? @default(now()) @map("share_at")

  document Document @relation(fields: [id_doc], references: [id], onDelete: Cascade)

  @@map("shares")
}

model AdminAction {
  id             Int      @id @default(autoincrement())
  admin_id       Int      @map("admin_id")
  target_user_id Int      @map("target_user_id")
  action_type    String   @map("action_type") // 'ban', 'unban', 'promote_admin', 'demote_admin'
  reason         String?
  details        Json?    // Pour stocker des informations supplémentaires
  created_at     DateTime @default(now()) @map("created_at")

  // Relations
  admin       User @relation("AdminActions", fields: [admin_id], references: [id], onDelete: Cascade)
  target_user User @relation("TargetUserActions", fields: [target_user_id], references: [id], onDelete: Cascade)

  @@map("admin_actions")
}

model TrashDocument {
  id         Int      @id @default(autoincrement())
  original_id Int?
  user_id    Int
  title      String
  content    String   @default("")
  tags       String[] @default([])
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  deleted_at DateTime @default(now())

  @@map("trash_documents")
}

model DeletedAccount {
  id                Int       @id @default(autoincrement())
  original_user_id  Int       @map("original_user_id")
  email             String
  username          String?
  first_name        String?   @map("first_name")
  last_name         String?   @map("last_name")
  provider          String?
  provider_id       String?
  profile_image     String?
  banner_image      String?
  is_admin          Boolean?  @map("is_admin")
  is_banned         Boolean?  @map("is_banned")
  user_snapshot     Json?     @map("user_snapshot")
  added_at          DateTime  @default(now()) @map("added_at")
  // Convenience: compute 30 days retention window in DB (PostgreSQL)
  expires_at        DateTime? @default(dbgenerated("now() + interval '30 days'")) @map("expires_at")

  @@index([original_user_id], map: "idx_deleted_accounts_original_user_id")
  @@index([email], map: "idx_deleted_accounts_email")
  @@map("deleted_accounts")
}
model Notification {
  id         Int      @id @default(autoincrement())
  id_sender   Int?
  id_receiver Int
  message     Json
  send_date   DateTime @default(now())
  read_date   DateTime?

  @@index([id_receiver], map: "idx_notifications_receiver")
  @@map("notifications")
}

model UserRequest {
  id           Int       @id @default(autoincrement())
  user_id      Int       @map("user_id")
  type         String    @default("other") // 'help', 'data_restoration', 'other'
  title        String
  description  String
  status       String    @default("pending") // 'pending', 'in_progress', 'resolved', 'rejected'
  validated    Boolean   @default(false)
  validated_by Int?      @map("validated_by")
  validated_at DateTime? @map("validated_at")
  created_at   DateTime  @default(now()) @map("created_at")
  updated_at   DateTime?  @updatedAt @map("updated_at")

  // Relations
  user      User  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  validator User? @relation("ValidatedRequests", fields: [validated_by], references: [id], onDelete: SetNull)

  @@index([user_id], map: "idx_user_requests_user_id")
  @@index([status], map: "idx_user_requests_status")
  @@index([validated], map: "idx_user_requests_validated")
  @@index([created_at], map: "idx_user_requests_created_at")
  @@map("user_requests")
}

model Dossier {
  id         Int      @id @default(autoincrement())
  user_id    Int      @map("user_id")
  nom        String
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  user      User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  documents DossierDocument[]

  @@index([user_id], map: "idx_dossiers_user_id")
  @@map("dossiers")
}

model DossierDocument {
  id          Int      @id @default(autoincrement())
  dossier_id  Int      @map("dossier_id")
  document_id Int      @map("document_id")
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  dossier  Dossier  @relation(fields: [dossier_id], references: [id], onDelete: Cascade)
  document Document  @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@unique([dossier_id, document_id], map: "idx_dossier_document_unique")
  @@index([dossier_id], map: "idx_dossier_document_dossier_id")
  @@index([document_id], map: "idx_dossier_document_document_id")
  @@map("dossier_documents")
}
